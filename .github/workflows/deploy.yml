name: Deploy to Digital Ocean

on:
  push:
    branches:
      - master

jobs:

  build:
    name: Build, push, and deploy
    runs-on: ubuntu-latest
    steps:

    - name: Checkout master
      uses: actions/checkout@master

    - name: Lint Dockerfile
      uses: brpaz/hadolint-action@v1.0.2

    - name: Build container image
      run: docker build -t docker.pkg.github.com/funkypenguin/funky-discord-docs-bot/funky-discord-docs-bot:${{ github.sha }} .

    - name: Docker login to GitHub Packages
      env:
        DOCKER_USERNAME: ${{ github.actor }}
        DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      run: docker login docker.pkg.github.com -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

    - name: Push image to GitHub Packages
      run: docker push docker.pkg.github.com/funkypenguin/funky-discord-docs-bot/funky-discord-docs-bot:${{ github.sha }}

    - name: 'Deploy chart'
      uses: 'deliverybot/helm@v1'
      with:
        release: 'funky-discord-docs-bot'
        namespace: 'funky-discord-docs-bot'
        helm: 'helm3'
        chart: 'charts/funky-discord-docs-bot'
        version: '${{ github.sha }}'
        token: '${{ github.token }}'
        values: |
          image:
            repository:   docker.pkg.github.com/funkypenguin/funky-discord-docs-bot/funky-discord-docs-bot:${{ github.sha }}
          discord:
            token:        ${{ secrets.DISCORD_BOT_TOKEN }}
      env:
        KUBECONFIG_FILE: '${{ secrets.KUBECONFIG }}'